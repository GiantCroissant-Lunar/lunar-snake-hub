- name: Verify SOPS is installed
  command: sops --version
  register: sops_version
  changed_when: false
  failed_when: sops_version.rc != 0

- name: Verify age is installed
  command: age --version
  register: age_version
  changed_when: false
  failed_when: age_version.rc != 0

- name: Create project .sops directory
  file:
    path: '{{ hub_repo_path }}/.sops'
    state: directory
    mode: '0700'

- name: Check if project age key exists
  stat:
    path: '{{ hub_repo_path }}/.sops/age.key'
  register: age_key_stat

- name: Set age key file permissions (if exists)
  file:
    path: '{{ hub_repo_path }}/.sops/age.key'
    mode: '0600'
  when: age_key_stat.stat.exists

- name: Display SOPS setup status
  debug:
    msg: |
      ✅ SOPS setup complete!

      🔐 SOPS version: {{ sops_version.stdout }}
      🔑 age version: {{ age_version.stdout }}
      📁 Project key: {{ hub_repo_path }}/.sops/age.key

      {% if age_key_stat.stat.exists %}
      ✅ Project age key found!
      {% else %}
      ⚠️  Project age key NOT found!

      You must copy your age key from Windows to Mac Mini:
      1. On Windows: Copy {{ hub_repo_path }}\.sops\age.key
      2. On Mac Mini: Paste to {{ hub_repo_path }}/.sops/age.key
      3. Set permissions: chmod 600 {{ hub_repo_path }}/.sops/age.key

      The .sops.yaml file automatically uses this project-scoped key.
      No environment variables needed!
      {% endif %}
