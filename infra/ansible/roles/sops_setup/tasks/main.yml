- name: Verify SOPS is installed
  command: sops --version
  register: sops_version
  changed_when: false
  failed_when: sops_version.rc != 0

- name: Verify age is installed
  command: age --version
  register: age_version
  changed_when: false
  failed_when: age_version.rc != 0

- name: Create SOPS age key directory
  file:
    path: '{{ sops_age_key_dir }}'
    state: directory
    mode: '0700'

- name: Check if age key exists
  stat:
    path: '{{ sops_age_key_file }}'
  register: age_key_stat

- name: Set age key file permissions (if exists)
  file:
    path: '{{ sops_age_key_file }}'
    mode: '0600'
  when: age_key_stat.stat.exists

- name: Set SOPS_AGE_KEY_FILE environment variable in .zshrc
  lineinfile:
    path: '{{ ansible_env.HOME }}/.zshrc'
    line: export SOPS_AGE_KEY_FILE="{{ sops_age_key_file }}"
    create: yes
    state: present

- name: Set SOPS_AGE_KEY_FILE in .bash_profile
  lineinfile:
    path: '{{ ansible_env.HOME }}/.bash_profile'
    line: export SOPS_AGE_KEY_FILE="{{ sops_age_key_file }}"
    create: yes
    state: present

- name: Display SOPS setup status
  debug:
    msg: |
      ✅ SOPS setup complete!

      🔐 SOPS version: {{ sops_version.stdout }}
      🔑 age version: {{ age_version.stdout }}
      📂 Key directory: {{ sops_age_key_dir }}
      📄 Key file: {{ sops_age_key_file }}

      {% if age_key_stat.stat.exists %}
      ✅ age key found at {{ sops_age_key_file }}
      {% else %}
      ⚠️  age key NOT found!

      You must copy your age key from Windows:
      1. On Windows: C:\Users\User\.config\sops\age\keys.txt
      2. Copy contents to Mac Mini: {{ sops_age_key_file }}
      3. Set permissions: chmod 600 {{ sops_age_key_file }}
      {% endif %}
